<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>/** Global declarations
 *
 * COPYRIGHT (c) 2018 Russell Maguire
 */

// Bus specification.
const int ADDR_WIDTH = 4;
const int MAX_LINE_WIDTH = 1;

const bool READ = true;
const bool WRITE = false;</declaration>
	<template>
		<name x="5" y="5">Core</name>
		<parameter>bool &amp;addr[ADDR_WIDTH], bool &amp;type, broadcast chan &amp;request, urgent chan &amp;response</parameter>
		<declaration>/** Core process template
 *
 * DESCRIPTION
 *    Template for process which generates randomly generates read and write requests
 *
 * INPUTS
 *    addr      - address bus array of boolean values
 *    readwrite - flag indicicating READ or WRITE
 *    request   - channel signaling memory request
 *    response  - channel signaling memory response
 *
 * COPYRIGHT (c) 2018 Russell Maguire
 */

clock t;</declaration>
		<location id="id0" x="-1036" y="-493">
			<name x="-1148" y="-501">ACCESS_END</name>
			<committed/>
		</location>
		<location id="id1" x="-756" y="-493">
			<name x="-740" y="-501">ACCESS_START</name>
			<committed/>
		</location>
		<location id="id2" x="-900" y="-493">
			<name x="-926" y="-476">WAITING</name>
		</location>
		<location id="id3" x="-1036" y="-357">
			<name x="-1084" y="-365">IDLE</name>
		</location>
		<init ref="id3"/>
		<transition>
			<source ref="id3"/>
			<target ref="id1"/>
			<label kind="select" x="-1020" y="-348">rand_addr0 : int[0,1],
rand_addr1 : int[0,1],
rand_addr2 : int[0,1],
rand_addr3 : int[0,1],
rand_type : int[0,1]</label>
			<label kind="assignment" x="-833" y="-348">addr[0] = rand_addr0,
addr[1] = rand_addr1,
addr[2] = rand_addr2,
addr[3] = rand_addr3,
type = rand_type</label>
			<nail x="-756" y="-357"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id3"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id2"/>
			<label kind="synchronisation" x="-851" y="-520">request!</label>
			<label kind="assignment" x="-851" y="-494">t = 0</label>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-994" y="-519">response?</label>
		</transition>
	</template>
	<template>
		<name>Memory</name>
		<parameter>urgent chan &amp;request, chan &amp;response</parameter>
		<declaration>// MemController declarations
// COPYRIGHT (c) 2018 Russell Maguire

const int TMIN = 25;
const int TMAX = 30;

clock t;</declaration>
		<location id="id4" x="-25" y="-221">
			<name x="-9" y="-237">ACCESSING</name>
			<label kind="invariant" x="-9" y="-221">t &lt;= TMAX</label>
		</location>
		<location id="id5" x="-169" y="-77">
			<name x="-217" y="-85">IDLE</name>
		</location>
		<init ref="id5"/>
		<transition>
			<source ref="id5"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="-17" y="-157">request?</label>
			<label kind="assignment" x="-17" y="-142">t = 0</label>
			<nail x="-25" y="-77"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id5"/>
			<label kind="guard" x="-156" y="-248">t &gt;= TMIN</label>
			<label kind="synchronisation" x="-156" y="-264">response!</label>
			<nail x="-169" y="-221"/>
		</transition>
	</template>
	<template>
		<name>CacheController</name>
		<parameter>bool &amp;type, urgent chan &amp;req, chan &amp;done, broadcast chan &amp;status, urgent chan &amp;hit, urgent chan &amp;invalid, chan &amp;read, chan &amp;write, chan &amp;rewrite, chan &amp;overwrite, urgent chan &amp;cache_done, chan &amp;mem_req, urgent chan &amp;mem_done</parameter>
		<location id="id6" x="-1369" y="-587">
			<name x="-1378" y="-570">END</name>
			<committed/>
		</location>
		<location id="id7" x="-1369" y="-705">
			<committed/>
		</location>
		<location id="id8" x="-1224" y="-705">
			<name x="-1208" y="-714">CHECK_INVALID</name>
			<urgent/>
		</location>
		<location id="id9" x="-1080" y="-705">
			<committed/>
		</location>
		<location id="id10" x="-1223" y="-773">
			<name x="-1334" y="-782">CHECK_HITW</name>
			<urgent/>
		</location>
		<location id="id11" x="-1504" y="-840">
			<name x="-1513" y="-824">READING_MEM</name>
		</location>
		<location id="id12" x="-1599" y="-705">
			<committed/>
		</location>
		<location id="id13" x="-1369" y="-646">
			<name x="-1463" y="-638">ACCESSING</name>
		</location>
		<location id="id14" x="-1504" y="-900">
			<name x="-1487" y="-909">CHECK_HITR</name>
			<urgent/>
		</location>
		<location id="id15" x="-1223" y="-841">
			<name x="-1207" y="-850">WRITE_START</name>
			<committed/>
		</location>
		<location id="id16" x="-1504" y="-960">
			<name x="-1487" y="-969">READ_START</name>
			<committed/>
		</location>
		<location id="id17" x="-1368" y="-994">
			<committed/>
		</location>
		<location id="id18" x="-1368" y="-1062">
			<name x="-1378" y="-1096">IDLE</name>
		</location>
		<init ref="id18"/>
		<transition>
			<source ref="id11"/>
			<target ref="id15"/>
			<label kind="synchronisation" x="-1486" y="-857">mem_done?</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id8"/>
			<label kind="synchronisation" x="-1215" y="-748">status!</label>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id18"/>
			<label kind="synchronisation" x="-1351" y="-604">done!</label>
			<nail x="-1004" y="-587"/>
			<nail x="-1003" y="-1062"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id6"/>
			<label kind="synchronisation" x="-1361" y="-629">cache_done?</label>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id13"/>
			<label kind="synchronisation" x="-1072" y="-688">rewrite!</label>
			<nail x="-1080" y="-646"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id13"/>
			<label kind="synchronisation" x="-1216" y="-688">overwrite!</label>
			<nail x="-1225" y="-646"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id13"/>
			<label kind="synchronisation" x="-1360" y="-688">write!</label>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-1343" y="-731">invalid?</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id9"/>
			<label kind="synchronisation" x="-1165" y="-792">hit?</label>
			<nail x="-1079" y="-773"/>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id10"/>
			<label kind="synchronisation" x="-1215" y="-815">status!</label>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id11"/>
			<label kind="synchronisation" x="-1496" y="-883">mem_req!</label>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id13"/>
			<label kind="synchronisation" x="-1591" y="-681">read!</label>
			<nail x="-1599" y="-646"/>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id12"/>
			<label kind="synchronisation" x="-1581" y="-918">hit?</label>
			<nail x="-1598" y="-901"/>
		</transition>
		<transition>
			<source ref="id16"/>
			<target ref="id14"/>
			<label kind="synchronisation" x="-1496" y="-942">status!</label>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id15"/>
			<label kind="guard" x="-1351" y="-1020">type == WRITE</label>
			<nail x="-1223" y="-994"/>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id16"/>
			<label kind="guard" x="-1487" y="-1020">type == READ</label>
			<nail x="-1504" y="-994"/>
		</transition>
		<transition>
			<source ref="id18"/>
			<target ref="id17"/>
			<label kind="synchronisation" x="-1360" y="-1045">req?</label>
		</transition>
	</template>
	<template>
		<name>CacheLine</name>
		<parameter>const int LINE_WIDTH, const bool line[MAX_LINE_WIDTH], bool &amp;addr[ADDR_WIDTH], urgent chan &amp;status, broadcast chan &amp;hit, broadcast chan &amp;miss, broadcast chan &amp;invalid, urgent chan &amp;read, urgent chan &amp;write, urgent chan &amp;rewrite, urgent chan &amp;overwrite, chan &amp;done, chan &amp;mem_req, urgent chan &amp;mem_res</parameter>
		<declaration>/**
 */

const int TMINR = 5;
const int TMAXR = 10;
const int TMINW = 25;
const int TMAXW = 30;

const int TAG_WIDTH = ADDR_WIDTH - LINE_WIDTH;
const int LINE_OFFSET = 0;
const int TAG_OFFSET = LINE_OFFSET + LINE_WIDTH;

bool tag[TAG_WIDTH];
bool valid = false;

// Local clock for timed cache accesses.
clock t;

bool is_cache_line()
{
    return forall (i : int[0,LINE_WIDTH-1]) addr[i+LINE_OFFSET] == line[i];
}

bool is_cache_valid()
{
    return valid;
}

bool is_cache_hit()
{
    return forall (i : int[0,TAG_WIDTH-1]) addr[i+TAG_OFFSET] == tag[i];
}

void update_cache()
{
    for (i : int[0,TAG_WIDTH-1]) tag[i] = addr[i+TAG_OFFSET];
    valid = true;
}</declaration>
		<location id="id19" x="-518" y="-841">
			<name x="-535" y="-824">END</name>
			<committed/>
		</location>
		<location id="id20" x="-706" y="-899">
			<name x="-689" y="-908">WAITING</name>
		</location>
		<location id="id21" x="-706" y="-967">
			<name x="-689" y="-984">WRITING</name>
			<label kind="invariant" x="-689" y="-967">t &lt;= TMAXW</label>
		</location>
		<location id="id22" x="-519" y="-967">
			<name x="-502" y="-984">READING</name>
			<label kind="invariant" x="-502" y="-967">t &lt;= TMAXR</label>
		</location>
		<location id="id23" x="-706" y="-1044">
			<committed/>
		</location>
		<location id="id24" x="-1045" y="-1105">
			<name x="-1062" y="-1088">NOTSELECTED</name>
		</location>
		<location id="id25" x="-901" y="-1309">
			<name x="-943" y="-1293">CHECK_LINE</name>
			<committed/>
		</location>
		<location id="id26" x="-748" y="-1247">
			<name x="-799" y="-1229">CHECK_VALID</name>
			<committed/>
		</location>
		<location id="id27" x="-884" y="-1103">
			<name x="-867" y="-1121">INVALID</name>
		</location>
		<location id="id28" x="-612" y="-1188">
			<name x="-654" y="-1171">CHECK_HIT</name>
			<committed/>
		</location>
		<location id="id29" x="-519" y="-1103">
			<name x="-501" y="-1121">HIT</name>
		</location>
		<location id="id30" x="-706" y="-1103">
			<name x="-688" y="-1121">MISS</name>
		</location>
		<init ref="id25"/>
		<transition>
			<source ref="id29"/>
			<target ref="id25"/>
			<label kind="synchronisation" x="-586" y="-1122">status?</label>
			<nail x="-1139" y="-1105"/>
			<nail x="-1139" y="-1385"/>
			<nail x="-901" y="-1385"/>
		</transition>
		<transition>
			<source ref="id30"/>
			<target ref="id25"/>
			<label kind="synchronisation" x="-773" y="-1122">status?</label>
			<nail x="-1139" y="-1105"/>
			<nail x="-1139" y="-1385"/>
			<nail x="-901" y="-1385"/>
		</transition>
		<transition>
			<source ref="id27"/>
			<target ref="id25"/>
			<label kind="synchronisation" x="-952" y="-1122">status?</label>
			<nail x="-1139" y="-1105"/>
			<nail x="-1139" y="-1385"/>
			<nail x="-901" y="-1385"/>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id25"/>
			<label kind="synchronisation" x="-1122" y="-1122">status?</label>
			<nail x="-1139" y="-1105"/>
			<nail x="-1139" y="-1385"/>
			<nail x="-901" y="-1385"/>
		</transition>
		<transition>
			<source ref="id19"/>
			<target ref="id25"/>
			<label kind="synchronisation" x="-493" y="-858">done!</label>
			<nail x="-374" y="-841"/>
			<nail x="-374" y="-1385"/>
			<nail x="-901" y="-1385"/>
		</transition>
		<transition>
			<source ref="id22"/>
			<target ref="id19"/>
			<label kind="guard" x="-510" y="-943">t &gt;= TMINR</label>
		</transition>
		<transition>
			<source ref="id20"/>
			<target ref="id19"/>
			<label kind="synchronisation" x="-688" y="-875">mem_res?</label>
			<label kind="assignment" x="-688" y="-858">update_cache()</label>
			<nail x="-705" y="-841"/>
		</transition>
		<transition>
			<source ref="id21"/>
			<target ref="id20"/>
			<label kind="guard" x="-697" y="-942">t &gt;= TMINW</label>
		</transition>
		<transition>
			<source ref="id23"/>
			<target ref="id21"/>
			<label kind="synchronisation" x="-697" y="-1027">mem_req!</label>
			<label kind="assignment" x="-697" y="-1010">t = 0</label>
		</transition>
		<transition>
			<source ref="id29"/>
			<target ref="id22"/>
			<label kind="synchronisation" x="-510" y="-1027">read?</label>
			<label kind="assignment" x="-510" y="-1010">t = 0</label>
		</transition>
		<transition>
			<source ref="id30"/>
			<target ref="id23"/>
			<label kind="synchronisation" x="-697" y="-1087">overwrite?</label>
		</transition>
		<transition>
			<source ref="id29"/>
			<target ref="id23"/>
			<label kind="synchronisation" x="-671" y="-1062">rewrite?</label>
			<nail x="-519" y="-1044"/>
		</transition>
		<transition>
			<source ref="id27"/>
			<target ref="id23"/>
			<label kind="synchronisation" x="-875" y="-1062">write?</label>
			<nail x="-884" y="-1044"/>
		</transition>
		<transition>
			<source ref="id25"/>
			<target ref="id24"/>
			<label kind="guard" x="-1029" y="-1334">!is_cache_line()</label>
			<nail x="-1045" y="-1309"/>
		</transition>
		<transition>
			<source ref="id25"/>
			<target ref="id26"/>
			<label kind="guard" x="-884" y="-1334">is_cache_line()</label>
			<nail x="-748" y="-1309"/>
		</transition>
		<transition>
			<source ref="id26"/>
			<target ref="id27"/>
			<label kind="guard" x="-884" y="-1272">!is_cache_valid()</label>
			<label kind="synchronisation" x="-875" y="-1147">invalid!</label>
			<nail x="-884" y="-1247"/>
		</transition>
		<transition>
			<source ref="id26"/>
			<target ref="id28"/>
			<label kind="guard" x="-723" y="-1272">is_cache_valid()</label>
			<nail x="-612" y="-1247"/>
		</transition>
		<transition>
			<source ref="id28"/>
			<target ref="id30"/>
			<label kind="guard" x="-731" y="-1213">!is_cache_hit()</label>
			<label kind="synchronisation" x="-697" y="-1147">miss!</label>
			<nail x="-706" y="-1188"/>
		</transition>
		<transition>
			<source ref="id28"/>
			<target ref="id29"/>
			<label kind="guard" x="-587" y="-1213">is_cache_hit()</label>
			<label kind="synchronisation" x="-510" y="-1147">hit!</label>
			<nail x="-519" y="-1188"/>
		</transition>
	</template>
	<system>/** Main memory system
 * COPYRIGHT (c) 2018 Russell Maguire
 */

/* Address bus */
bool addr[ADDR_WIDTH];
bool type;

/* For cache lines */
const bool line[2][MAX_LINE_WIDTH] = {{0}, {1}};

/* Channels */
chan request;
chan response;

chan mem_request;
chan mem_response;

// Used to update and query cache line state
broadcast chan cache_status;

broadcast chan cache_hit;
broadcast chan cache_miss;
broadcast chan cache_invalid;

// Cache operations
chan cache_read;
chan cache_write;
chan cache_rewrite;
chan cache_overwrite;

chan cache_done;

core = Core(
    addr,
    type,
    request,
    response
);
memory = Memory(
    mem_request,
    mem_response
);
cache_controller = CacheController(
    type,
    request,
    response,
    cache_status,
    cache_hit,
    cache_invalid,
    cache_read,
    cache_write,
    cache_rewrite,
    cache_overwrite,
    cache_done,
    mem_request,
    mem_response
);
cache_line(const int[0,1] idx) = CacheLine(
    0,
    line[idx],
    addr,
    cache_status,
    cache_hit,
    cache_miss,
    cache_invalid,
    cache_read,
    cache_write,
    cache_rewrite,
    cache_overwrite,
    cache_done,
    mem_request,
    mem_response
);

system core, memory, cache_controller, cache_line;</system>
	<queries>
		<query>
			<formula>E&lt;&gt;synchroniser.END and (cache_counter(2).cache_hits &gt; cache_counter(1).cache_hits) and (cache_counter(2).cache_misses &lt; cache_counter(1).cache_misses)
			</formula>
			<comment>
			</comment>
		</query>
		<query>
			<formula>core.ACCESS_START --&gt; core.ACCESS_END
			</formula>
			<comment>
			</comment>
		</query>
	</queries>
</nta>
